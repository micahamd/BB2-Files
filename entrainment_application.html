<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Biofeedback Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="info-icon" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-breathing" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12c2.667 0 4 2.239 4 5s1.333 5 4 5s4 -2.239 4 -5s1.333 -5 4 -5" /><path d="M12 20v-15a4 4 0 0 0 -4 -4h-1" /><path d="M12 5a4 4 0 0 1 4 -4h1" /></symbol>
        <symbol id="icon-visual" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 18l-3.39 -6l-6.61 -2l18 8l-8 2z" /><path d="M12 18l8 -10l-8.5 -5l-6.5 12.5" /></symbol>
        <symbol id="icon-eye" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /><path d="M3 12h2" /><path d="M19 12h2" /></symbol>
        <symbol id="icon-audio" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8a4 4 0 0 1 0 8" /><path d="M17.7 5a9 9 0 0 1 0 14" /><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" /></symbol>
        <symbol id="icon-question" viewBox="0 0 20 20" fill="currentColor">
    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
</symbol>
<symbol id="icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></symbol>
    </svg>
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --text-muted: #64748b; /* slate-500 */
            --accent-color: #38bdf8; /* sky-500 */
            --accent-hover: #0ea5e9; /* sky-600 */
            --border-color: #cbd5e1; /* slate-300 */
            --input-bg: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
            --modal-bg: rgba(0,0,0,0.5);
            --tooltip-bg: #334155; /* slate-700 */
            --tooltip-text: #ffffff;
            --button-text-color: #ffffff;
            --fullscreen-overlay-bg: rgba(255, 255, 255, 0.8);
            --fullscreen-overlay-text: #111827;
        }

        .modal-content a {
            color: var(--accent-color);
        }
        .modal-content a:hover {
            text-decoration: underline;
        }
        .info-header-button {
            padding: 0;
            min-height: auto;
            background: none;
        }
        .info-header-button:hover {
            background: none;
        }

        .dark-mode {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-muted: #64748b; /* slate-500 */
            --accent-color: #38bdf8; /* sky-500 */
            --accent-hover: #7dd3fc; /* sky-300 */
            --border-color: #475569; /* slate-600 */
            --input-bg: #334155; /* slate-700 */
            --card-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.1);
            --modal-bg: rgba(0,0,0,0.7);
            --tooltip-bg: #f1f5f9; /* slate-100 */
            --tooltip-text: #1e293b; /* slate-800 */
            --button-text-color: #ffffff;
            --fullscreen-overlay-bg: rgba(0, 0, 0, 0.6);
            --fullscreen-overlay-text: #f9fafb;
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .body-no-scroll {
            overflow: hidden !important;
        }
        .app-section {
            background-color: var(--bg-secondary);
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .app-section h2, .app-section h3 {
            color: var(--text-primary);
             transition: color 0.3s ease;
        }
        .app-section p, .app-section label, .app-section span:not(.info-icon):not(.dot) {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .app-section input[type=number],
        .app-section input[type=color],
        .app-section input[type=email],
        .app-section input[type=password],
        .app-section select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .app-section input[type=range]::-webkit-slider-thumb {
            background-color: var(--accent-color);
        }
        .app-section input[type=range]::-moz-range-thumb {
            background-color: var(--accent-color);
        }
        .app-section button:not(.info-header-button) {
            background-color: var(--accent-color);
            color: var(--button-text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .app-section button:not(.info-header-button):hover {
            background-color: var(--accent-hover);
        }
        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .modal-content p, .modal-content li {
             color: var(--text-secondary);
        }

        #breathingCircle {
            transition: transform 1s ease-in-out, background-color 0.5s ease;
        }
        input[type=number] {
            -webkit-appearance: none; -moz-appearance: textfield; appearance: none; margin: 0;
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        #visualArea {
            transition-property: background-color;
            transition-timing-function: ease-in-out;
        }
        #authModal, #photosensitivityWarningModal, #emdrDisclaimerModal, #audioDisclaimerModal, #firstTimeUserGuideModal, #breathingInfoModal, #visualInfoModal, #eyeMovementInfoModal, #audioInfoModal, #moodQuestionnaireModal, #resetConfirmationModal {
            background-color: var(--modal-bg);
            z-index: 2000 !important;
        }
        #eyeMovementArea { position: relative; overflow: hidden; }
        .emdr-bar { position: absolute; top: 0; bottom: 0; width: 10px; transition: background-color 0.3s ease; }
        #emdrBarLeft { left: 0; }
        #emdrBarRight { right: 0; }
        #emdrBall { position: absolute; top: 50%; width: 24px; height: 24px; border-radius: 50%; transform: translateY(-50%); transition: background-color 0.3s ease, left 0.1s linear, transform 0.3s ease; }
        #audioArea { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .audio-icon { width: 80px; height: 80px; margin-bottom: 20px; }

        .fullscreen-module {
            position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
            z-index: 1000 !important; display: flex !important; align-items: center !important; justify-content: center !important;
            overflow: hidden !important; transition: background-color 0.3s ease;
        }
        .fullscreen-timer, .fullscreen-quit-btn, .fullscreen-phase-indicator {
            position: fixed !important; z-index: 1001 !important;
            background-color: var(--fullscreen-overlay-bg) !important;
            color: var(--fullscreen-overlay-text) !important;
            backdrop-filter: blur(4px); padding: 0.5rem 0.75rem; border-radius: 0.375rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .fullscreen-timer { top: 20px !important; right: 20px !important; }
        .fullscreen-quit-btn { 
            top: 20px !important; 
            left: 20px !important; 
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }
        .fullscreen-quit-btn:hover {
            background-color: rgba(200, 200, 200, 0.5);
        }
        .dark-mode .fullscreen-quit-btn:hover {
            background-color: rgba(50, 50, 50, 0.5);
        }
        .fullscreen-phase-indicator { bottom: 30px !important; left: 50% !important; transform: translateX(-50%) !important; font-size: 1.125rem; }

        .info-icon-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 6px;
            cursor: help;
            position: relative;
        }
        .info-icon-svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }
        .info-icon-container:hover .info-icon-svg {
            color: var(--accent-color);
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 135%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(167, 1, 1, 0.504);
        }
        .info-icon-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .theme-toggle-label {
            width: 50px;
            height: 28px;
        }
        .theme-toggle-label .dot {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            background-color: white;
        }
        input:checked ~ .theme-toggle-label .dot {
            transform: translateX(22px);
        }
        input:checked ~ .theme-toggle-label {
            background-color: var(--accent-color);
        }
        .theme-toggle-container .text-sm {
             color: var(--text-secondary);
        }
        
        .module-card {
            background-color: var(--bg-primary);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            text-align: center;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }
        .module-card svg {
            margin: 0 auto;
            width: 48px;
            height: 48px;
            color: var(--accent-color);
        }
        .module-card h3 {
             color: var(--text-primary);
        }
        .module-card p {
            color: var(--text-secondary);
        }
        .back-to-dashboard-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 0.5rem;
            transition: color 0.2s ease;
        }
        .back-to-dashboard-btn:hover {
             color: var(--accent-color);
        }

        /* Auth Modal Styles */
        .auth-tab {
            border-bottom: 2px solid transparent;
        }
        .auth-tab.active {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        
        /* Mood Questionnaire Styles */
        #mood-likert-scale {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        #mood-likert-scale label {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            padding: 0 4px;
        }
        #mood-likert-scale input[type="radio"] {
            margin-bottom: 5px;
        }
        #mood-likert-scale span {
            font-size: 0.75rem; /* 12px */
        }


        @media (max-width: 768px) {
            input[type=range] { height: 24px; }
            input[type=range]::-webkit-slider-thumb { width: 24px; height: 24px; }
            input[type=range]::-moz-range-thumb { width: 24px; height: 24px; }
            button { min-height: 44px; }
            select, input[type=number], input[type=color] { min-height: 44px; font-size: 16px; }
            * { touch-action: manipulation; }
            #audioArea .audio-icon { width: 100px; height: 100px; }
            #audioDisplayText { font-size: 1.25rem; }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .fullscreen-phase-indicator {
                font-size: 1rem; /* 16px */
                bottom: 15px !important;
                padding: 0.375rem 0.625rem;
            }
            .fullscreen-timer, .fullscreen-quit-btn {
                top: 10px !important;
            }
            .fullscreen-timer { right: 10px !important; }
            .fullscreen-quit-btn { left: 10px !important; }

            .app-section > header {
                margin-bottom: 1rem; /* 16px, was 32px */
            }
            .app-section h2 {
                font-size: 1.5rem; /* 24px, was 30/36px */
            }
        }

    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 sm:p-6 selection:bg-sky-200">

    <div id="mainAppWrapper" class="w-full max-w-xl mx-auto">
        <header id="mainAppHeader" class="text-center my-6 sm:my-8 relative">
            <h1 class="text-4xl font-bold">Biofeedback Suite</h1>
            <div class="absolute top-0 right-0 mt-1 mr-1 sm:mt-0 sm:mr-0 flex items-center space-x-4 h-full">
                <div id="auth-container" class="flex items-center space-x-3">
                    <!-- This will be dynamically filled -->
                </div>
                <div class="theme-toggle-container flex items-center space-x-2">
                    <span class="text-sm">Light</span>
                    <label for="themeToggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="themeToggle" class="sr-only">
                            <div class="theme-toggle-label block bg-gray-400 dark:bg-slate-600 w-12 h-7 rounded-full transition-colors"></div>
                            <div class="dot absolute left-1 top-1 w-5 h-5 rounded-full transition-transform"></div>
                        </div>
                    </label>
                    <span class="text-sm">Dark</span>
                </div>
            </div>
        </header>

        <div id="firstTimeUserGuideModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full">
                <h3 class="text-2xl font-bold mb-4 text-center">Welcome to the Biofeedback Suite!</h3>
                <p class="text-base mb-3">This app offers several tools to help you manage stress, improve focus, and relax.</p>
                <div class="space-y-3 my-4">
                    <div>
                        <h4 class="font-semibold text-lg">Breathing Control</h4>
                        <p class="text-sm">Synchronize your breathing with an animated circle that expands and contracts.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg">Visual Entrainment</h4>
                        <p class="text-sm">Entrainment of visual system with customizable flicker.<strong class="text-red-500 dark:text-red-400">Use with caution if photosensitive.</strong></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg">Guided Eye Movement</h4>
                        <p class="text-sm">Follow a moving ball with your eyes.
                    </div>
                     <div>
                        <h4 class="font-semibold text-lg">Auditory Entrainment</h4>
                        <p class="text-sm">Listen to binaural beats, isochronic tones, or pink noise only with optional pink noise background to entrain audio systems. <strong class="text-purple-500 dark:text-purple-400">Headphones recommended for Binaural Beats.</strong></p>
                    </div>
                </div>
                <p class="text-sm mb-6">Modify module settings to customize your experience. You can quit any active session by pressing 'Q' on a keyboard or using the 'Quit' button.</p>
                <button id="closeUserGuideButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">Begin</button>
            </div>
        </div>

        <section id="wellnessHub" class="app-section p-6 sm:p-8 rounded-xl mb-10 hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-2">My Wellness Hub</h2>
            <p class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6">Welcome back! Here's a summary of your progress.</p>
            
            <div class="flex items-center justify-center mb-8">
                <input type="checkbox" id="moodMeasureCheckbox" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                <label for="moodMeasureCheckbox" class="ml-2 block text-sm">
                    Enable pre & post session mood measurement
                </label>
            </div>

            <div id="progressVisualization" class="mb-8">
                 <h3 class="text-xl font-semibold text-center mb-4">Mood Over Time</h3>
                 <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg shadow-inner">
                    <canvas id="moodChart"></canvas>
                 </div>
            </div>

            <h3 class="text-xl font-semibold text-center mb-4">Session History</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                    <thead class="bg-slate-50 dark:bg-slate-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Module</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Duration</th>
                             <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Mood (Pre/Post)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Settings</th>
                        </tr>
                    </thead>
                    <tbody id="sessionHistoryTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <!-- Session history will be populated here by JavaScript -->
                         <tr><td colspan="5" class="px-6 py-10 text-center text-sm">No session history yet. Complete a session to see it here!</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-8 text-center space-x-4">
                <button id="downloadProgressBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors hidden">Download Progress</button>
                <button id="resetProgressBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">Reset All Progress</button>
            </div>
        </section>

        <section id="dashboard" class="app-section p-6 sm:p-8 rounded-xl mb-10">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-8">Choose a Module</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                
                <div class="module-card" data-module="breathing">
                    <svg><use xlink:href="#icon-breathing"></use></svg>
                    <h3 class="text-xl font-semibold mt-4">Breathing Control</h3>
                    <p class="text-sm mt-1 text-slate-500 dark:text-slate-400">Sync your breath with a visual guide.</p>
                </div>

                <div class="module-card" data-module="visual">
                    <svg><use xlink:href="#icon-visual"></use></svg>
                    <h3 class="text-xl font-semibold mt-4">Visual Entrainment</h3>
                    <p class="text-sm mt-1 text-slate-500 dark:text-slate-400">Focus on gentle, rhythmic light patterns.</p>
                </div>

                <div class="module-card" data-module="eyeMovement">
                    <svg><use xlink:href="#icon-eye"></use></svg>
                    <h3 class="text-xl font-semibold mt-4">Guided Eye Movement</h3>
                    <p class="text-sm mt-1 text-slate-500 dark:text-slate-400">Follow a moving object with your eyes.</p>
                </div>

                <div class="module-card" data-module="audio">
                    <svg><use xlink:href="#icon-audio"></use></svg>
                    <h3 class="text-xl font-semibold mt-4">Auditory Entrainment</h3>
                    <p class="text-sm mt-1 text-slate-500 dark:text-slate-400">Listen to focusing binaural beats, isochronic tones, or pure pink noise.</p>
                </div>

            </div>
        </section>
        
        <section id="breathingControlApp" class="app-section p-6 sm:p-8 rounded-xl mb-10 hidden">
            <header class="text-center mb-8 relative">
                <button class="back-to-dashboard-btn hidden absolute top-0 left-0 text-sm font-medium">&larr; Dashboard</button>
                <div class="flex items-center justify-center">
                    <h2 class="text-2xl sm:text-3xl font-bold">Breathing Control</h2>
                    <button id="breathingInfoBtn" class="info-header-button ml-2 text-slate-400 hover:text-sky-500 transition-colors">
                        <svg class="w-6 h-6"><use xlink:href="#icon-question"></use></svg>
                    </button>
                </div>
                <p class="mt-1">Sync your breath with the rhythm of the circle.</p>
            </header>
            <div id="breathingSettingsPanel">
                <h3 class="text-xl font-semibold mb-6 text-center">Customize Breathing Control Session</h3>
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-center">Breathing Pattern (seconds)</label>
                        <div class="grid grid-cols-4 gap-3">
                            <div>
                                <label for="inhaleDuration" class="block text-xs font-medium text-center mb-1">Inhale</label>
                                <input type="number" id="inhaleDuration" value="4" min="1" max="30" class="w-full p-3 text-center border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="holdDuration" class="block text-xs font-medium text-center mb-1">Hold</label>
                                <input type="number" id="holdDuration" value="2" min="0" max="30" class="w-full p-3 text-center border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="exhaleDuration" class="block text-xs font-medium text-center mb-1">Exhale</label>
                                <input type="number" id="exhaleDuration" value="4" min="1" max="30" class="w-full p-3 text-center border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="holdAfterExhaleDuration" class="block text-xs font-medium text-center mb-1">Hold</label>
                                <input type="number" id="holdAfterExhaleDuration" value="2" min="0" max="30" class="w-full p-3 text-center border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="breathingDuration" class="block text-sm font-medium mb-1">Duration (minutes)
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Total length of the breathing exercise. Recommended: 3-10 minutes.</span>
                            </span>
                        </label>
                        <input type="number" id="breathingDuration" value="5" min="1" max="60" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="circleColor" class="block text-sm font-medium mb-1">Circle Color
                                <span class="info-icon-container">
                                    <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                    <span class="tooltip-text">Sets the main color of the breathing circle.</span>
                                </span>
                            </label>
                            <input type="color" id="circleColor" value="#38bdf8" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                        <div>
                            <label for="breathingBgColor" class="block text-sm font-medium mb-1">Background Color
                                <span class="info-icon-container">
                                    <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                    <span class="tooltip-text">Sets the background color of the animation area during the session.</span>
                                </span>
                            </label>
                            <input type="color" id="breathingBgColor" value="#f1f5f9" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                    </div>
                </div>
                <button id="startBreathingButton" class="start-module-btn mt-8 w-full font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform active:scale-95">Start Breathing Cycle</button>
            </div>
            <div id="breathingArea" class="w-full aspect-square max-w-md mx-auto flex items-center justify-center my-8 relative hidden rounded-xl shadow-xl">
                <div id="breathingCircle" class="w-1/4 h-1/4 rounded-full" style="transform: scale(0.8);"></div>
                <div id="breathingTimerDisplay" class="absolute top-4 right-4 text-lg font-semibold px-3 py-1 rounded-md shadow">00:00</div>
                <div id="breathingPhaseIndicator" class="absolute bottom-6 text-lg font-medium px-4 py-2 rounded-md shadow">Prepare...</div>
                        <button class="fullscreen-quit-btn quit-module-btn"><svg class="w-6 h-6"><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div id="breathingMessageArea" class="text-center mt-4 min-h-[2em]"></div>
        </section>

        <section id="visualEntrainmentApp" class="app-section p-6 sm:p-8 rounded-xl mb-10 hidden">
            <header class="text-center mb-8 relative">
                <button class="back-to-dashboard-btn hidden absolute top-0 left-0 text-sm font-medium">&larr; Dashboard</button>
                <div class="flex items-center justify-center">
                    <h2 class="text-2xl sm:text-3xl font-bold">Visual Entrainment</h2>
                     <button id="visualInfoBtn" class="info-header-button ml-2 text-slate-400 hover:text-sky-500 transition-colors">
                        <svg class="w-6 h-6"><use xlink:href="#icon-question"></use></svg>
                    </button>
                </div>
                <p class="mt-1">Keep your attention on the alternating colors.</p>
            </header>
            <div id="visualSettingsPanel">
                <h3 class="text-xl font-semibold mb-6 text-center">Customize Visual Flicker Session</h3>
                <div class="space-y-5">
                    <div>
                        <label for="visualDuration" class="block text-sm font-medium mb-1">Duration (minutes)
                             <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Total length of the visual flicker session.</span>
                            </span>
                        </label>
                        <input type="number" id="visualDuration" value="2" min="1" max="30" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="frequency" class="block text-sm font-medium mb-1">Frequency (Hz): <span id="frequencyValue" class="font-semibold text-teal-600 dark:text-teal-400">10.0</span>
                             <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Rate of flicker in Hertz (cycles per second).</span>
                            </span>
                        </label>
                        <input type="range" id="frequency" min="0.1" max="60" value="10" step="0.1" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-teal-500 dark:accent-teal-400">
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="foregroundSize" class="block text-sm font-medium mb-1">Foreground Size: <span id="foregroundSizeValue" class="font-semibold text-teal-600 dark:text-teal-400">80%</span></label>
                            <input type="range" id="foregroundSize" min="0" max="100" value="80" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-teal-500 dark:accent-teal-400">
                        </div>
                        <div>
                            <label for="transitionSpeed" class="block text-sm font-medium mb-1">Transition: <span id="transitionSpeedValue" class="font-semibold text-teal-600 dark:text-teal-400">50%</span></label>
                            <input type="range" id="transitionSpeed" min="1" max="100" value="50" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-teal-500 dark:accent-teal-400">
                        </div>
                    </div>
                    <div>
                        <label for="foregroundShape" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Shape</label>
                        <select id="foregroundShape" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            <option value="circle" selected>Circle</option>
                            <option value="square">Square</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="patternColor1" class="block text-sm font-medium mb-1">Foreground Color</label>
                            <input type="color" id="patternColor1" value="#4fd1c5" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                        <div>
                            <label for="patternColor2" class="block text-sm font-medium mb-1">Background Color</label>
                            <input type="color" id="patternColor2" value="#2d3748" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                    </div>
                </div>
                <button id="startVisualButton" class="start-module-btn mt-8 w-full font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform active:scale-95">Start Flicker Session</button>
            </div>
            <div id="visualArea" class="w-full aspect-square max-w-md mx-auto my-8 relative hidden rounded-xl shadow-xl overflow-hidden">
                <div id="visualShape" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                <div id="visualTimerDisplay" class="absolute top-4 right-4 text-lg font-semibold px-3 py-1 rounded-md shadow">00:00</div>
                <button class="fullscreen-quit-btn quit-module-btn"><svg class="w-6 h-6"><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div id="visualMessageArea" class="text-center mt-4 min-h-[2em]"></div>
        </section>

        <section id="eyeMovementApp" class="app-section p-6 sm:p-8 rounded-xl mb-10 hidden">
            <header class="text-center mb-8 relative">
                <button class="back-to-dashboard-btn hidden absolute top-0 left-0 text-sm font-medium">&larr; Dashboard</button>
                <div class="flex items-center justify-center">
                    <h2 class="text-2xl sm:text-3xl font-bold">Guided Eye Movement</h2>
                    <button id="eyeMovementInfoBtn" class="info-header-button ml-2 text-slate-400 hover:text-sky-500 transition-colors">
                        <svg class="w-6 h-6"><use xlink:href="#icon-question"></use></svg>
                    </button>
                </div>
                <p class="mt-1">Follow the ball with your eyes.</p>
            </header>
            <div id="eyeMovementSettingsPanel">
                <h3 class="text-xl font-semibold mb-6 text-center">Customize Guided Eye Movement Session</h3>
                <div class="space-y-5">
                    <div>
                        <label for="eyeMovementDuration" class="block text-sm font-medium mb-1">Duration (minutes)
                             <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Total length of the eye movement exercise.</span>
                            </span>
                        </label>
                        <input type="number" id="eyeMovementDuration" value="3" min="1" max="30" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="ballSpeed" class="block text-sm font-medium mb-1">Ball Speed: <span id="ballSpeedValue" class="font-semibold text-indigo-600 dark:text-indigo-400">5.0</span>
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Controls how fast the ball moves.</span>
                            </span>
                        </label>
                        <input type="range" id="ballSpeed" min="1" max="10" value="5" step="0.5" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 dark:accent-indigo-400">
                    </div>
                    <div>
                        <label for="ballSize" class="block text-sm font-medium mb-1">Ball Size: <span id="ballSizeValue" class="font-semibold text-indigo-600 dark:text-indigo-400">24px</span>
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Controls the diameter of the ball.</span>
                            </span>
                        </label>
                        <input type="range" id="ballSize" min="10" max="50" value="24" step="1" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 dark:accent-indigo-400">
                    </div>
                    <div>
                        <label for="eyeMovementPath" class="block text-sm font-medium mb-1">Movement Path
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Determines the trajectory of the ball. 'Horizontal' is standard.</span>
                            </span>
                        </label>
                        <select id="eyeMovementPath" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="horizontal" selected>Horizontal</option>
                            <option value="circular">Circular</option>
                            <option value="figureEight">Figure-Eight</option>
                        </select>
                    </div>
                     <div>
                        <label for="ballPulse" class="block text-sm font-medium mb-1">Ball Pulsing
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Ball will subtly change size and color as it moves.</span>
                            </span>
                        </label>
                        <select id="ballPulse" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none" selected>None</option>
                            <option value="subtle">Subtle Pulse</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="ballColor" class="block text-sm font-medium mb-1">Ball Color</label>
                            <input type="color" id="ballColor" value="#818cf8" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                        <div>
                            <label for="barColor" class="block text-sm font-medium mb-1">Bar Color</label>
                            <input type="color" id="barColor" value="#4338ca" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                        <div>
                            <label for="eyeMovementBgColor" class="block text-sm font-medium mb-1">Background</label>
                            <input type="color" id="eyeMovementBgColor" value="#e0e7ff" class="w-full h-10 p-1 border rounded-lg shadow-sm cursor-pointer">
                        </div>
                    </div>
                </div>
                <button id="startEyeMovementButton" class="start-module-btn mt-8 w-full font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform active:scale-95">Start Eye Movement Exercise</button>
            </div>
            <div id="eyeMovementArea" class="w-full aspect-[16/9] max-w-md mx-auto my-8 relative hidden rounded-xl shadow-xl">
                <div id="emdrBarLeft" class="emdr-bar"></div>
                <div id="emdrBarRight" class="emdr-bar"></div>
                <div id="emdrBall"></div>
                <div id="eyeMovementTimerDisplay" class="absolute top-4 right-4 text-lg font-semibold px-3 py-1 rounded-md shadow">00:00</div>
                        <button class="fullscreen-quit-btn quit-module-btn"><svg class="w-6 h-6"><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div id="eyeMovementMessageArea" class="text-center mt-4 min-h-[2em]"></div>
        </section>

        <section id="audioEntrainmentApp" class="app-section p-6 sm:p-8 rounded-xl mb-10 hidden">
            <header class="text-center mb-8 relative">
                 <button class="back-to-dashboard-btn hidden absolute top-0 left-0 text-sm font-medium">&larr; Dashboard</button>
                <div class="flex items-center justify-center">
                    <h2 class="text-2xl sm:text-3xl font-bold">Auditory Entrainment</h2>
                    <button id="audioInfoBtn" class="info-header-button ml-2 text-slate-400 hover:text-sky-500 transition-colors">
                        <svg class="w-6 h-6"><use xlink:href="#icon-question"></use></svg>
                    </button>
                </div>
                <p class="mt-1">Select tone type and customize your session.</p>
            </header>
            <div id="audioSettingsPanel">
                <h3 class="text-xl font-semibold mb-6 text-center">Customize Auditory Session</h3>
                <div class="space-y-5">
                    <div>
                        <label for="audioDuration" class="block text-sm font-medium mb-1">Duration (minutes)
                             <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Total length of the auditory entrainment session.</span>
                            </span>
                        </label>
                        <input type="number" id="audioDuration" value="10" min="1" max="60" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="toneType" class="block text-sm font-medium mb-1">Tone Type
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">'Binaural Beats' require headphones for two different frequencies. 'Isochronic Tones' present rhythmic pulses of a single tone. 'Pink Noise Only' provides soothing background noise without tones.</span>
                            </span>
                        </label>
                        <select id="toneType" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="binaural" selected>Binaural Beats</option>
                            <option value="isochronic">Isochronic Tones</option>
                            <option value="pinknoise">Pink Noise Only</option>
                        </select>
                    </div>
                    <div id="pinkNoiseSection">
                        <label class="flex items-center space-x-3 text-sm font-medium" id="pinkNoiseCheckboxLabel">
                            <input type="checkbox" id="pinkNoiseEnabled" class="w-4 h-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500 focus:ring-2">
                            <span>Add Pink Noise Background</span>
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text">Pink noise provides a soothing background sound that can enhance relaxation and mask distracting environmental sounds.</span>
                            </span>
                        </label>
                        <div id="pinkNoiseVolumeControl" class="mt-3 hidden">
                            <label for="pinkNoiseVolume" class="block text-sm font-medium mb-1">
                                Pink Noise Volume: <span id="pinkNoiseVolumeDisplay" class="font-semibold text-purple-600 dark:text-purple-400">30%</span>
                            </label>
                            <input type="range" id="pinkNoiseVolume" min="0" max="100" value="30" step="5" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500 dark:accent-purple-400">
                        </div>
                    </div>
                    <div>
                        <label for="carrierFrequencyControl" class="block text-sm font-medium mb-1">
                            <span id="carrierFreqLabel">Carrier Frequency (Hz):</span>
                            <span id="baseToneFreqLabel" class="hidden">Base Tone Frequency (Hz):</span>
                            <span id="carrierFreqValueDisplay" class="font-semibold text-purple-600 dark:text-purple-400">200</span>
                            <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text" id="carrierInfoText">For Binaural: The base frequency one ear hears. For Isochronic: The frequency of the tone that pulses. Common range: 100-500Hz.</span>
                            </span>
                        </label>
                        <input type="range" id="carrierFrequencyControl" min="100" max="1000" value="200" step="10" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500 dark:accent-purple-400">
                    </div>
                    <div>
                        <label for="beatFrequencyControl" class="block text-sm font-medium mb-1">
                            <span id="beatFreqLabel">Binaural Beat (Hz):</span>
                            <span id="pulseFreqLabel" class="hidden">Pulse Frequency (Hz):</span>
                            <span id="beatFreqValueDisplay" class="font-semibold text-purple-600 dark:text-purple-400">10.0</span>
                             <span class="info-icon-container">
                                <svg class="info-icon-svg"><use xlink:href="#info-icon"></use></svg>
                                <span class="tooltip-text" id="beatInfoText">For Binaural: The difference in Hz between ears, perceived as a beat. For Isochronic: The rate of the tone pulses. (e.g., Delta: 1-4Hz, Theta: 4-8Hz, Alpha: 8-12Hz, Beta: 12-30Hz).</span>
                            </span>
                        </label>
                        <input type="range" id="beatFrequencyControl" min="0.5" max="30" value="10" step="0.5" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500 dark:accent-purple-400">
                    </div>
                </div>
                <button id="startAudioButton" class="start-module-btn mt-8 w-full font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform active:scale-95">Start Auditory Session</button>
            </div>
            <div id="audioArea" class="w-full aspect-square max-w-md mx-auto my-8 relative hidden rounded-xl shadow-xl">
                <svg id="audioDisplayIcon" class="audio-icon text-purple-500 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                <p id="audioDisplayText" class="text-lg text-purple-700 dark:text-purple-300">Playing Binaural Tones...</p>
                <div id="audioTimerDisplay" class="absolute top-4 right-4 text-lg font-semibold px-3 py-1 rounded-md shadow">00:00</div>
                         <button class="fullscreen-quit-btn quit-module-btn"><svg class="w-6 h-6"><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div id="audioMessageArea" class="text-center mt-4 min-h-[2em]"></div>
        </section>

        <!-- Modals -->
        <div id="authModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
             <div id="authModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content relative p-6 sm:p-8 rounded-xl shadow-2xl max-w-sm w-full z-10">
                <button id="closeAuthModal" class="absolute top-4 right-4 text-slate-400 hover:text-sky-500 transition-colors">
                    <svg class="w-6 h-6"><use xlink:href="#icon-close"></use></svg>
                </button>
                <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                    <button data-tab="login" class="auth-tab flex-1 py-3 font-semibold text-center transition-colors active">Sign In</button>
                    <button data-tab="register" class="auth-tab flex-1 py-3 font-semibold text-center transition-colors">Create Account</button>
                </div>

                <!-- Sign In Form -->
                <form id="loginForm" class="auth-form space-y-4 active">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium mb-1">Email Address</label>
                        <input type="email" id="loginEmail" required class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="loginPassword" required class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">Sign In</button>
                    <p id="loginError" class="text-red-500 text-sm text-center h-4"></p>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form space-y-4">
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium mb-1">Email Address</label>
                        <input type="email" id="registerEmail" required class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="registerPassword" required minlength="6" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                         <p class="text-xs text-slate-400 mt-1">Minimum 6 characters.</p>
                    </div>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">Create Account</button>
                    <p id="registerError" class="text-red-500 text-sm text-center h-4"></p>
                </form>
            </div>
        </div>
        
        <div id="moodQuestionnaireModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div id="moodQuestionnaireModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content relative p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full z-10">
                <h3 class="text-xl font-bold mb-4 text-center">Mood Check-in</h3>
                <form id="moodForm">
                    <!-- Dynamic content will be inserted here by JavaScript -->
                </form>
            </div>
        </div>
        
        <div id="resetConfirmationModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 text-center">Reset Progress</h3>
                <p class="text-sm mb-6 text-center">Are you sure you want to permanently delete all session history? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancelResetBtn" class="px-6 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button>
                    <button id="confirmResetBtn" class="px-6 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">Confirm Reset</button>
                </div>
            </div>
        </div>
        
        <div id="photosensitivityWarningModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden"><div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full"><h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 text-center">Photosensitivity Warning</h3><p class="text-sm mb-2">This exercise involves alternating flashing patterns. They may potentially trigger seizures or other aversive effects in photosensitive individuals.</p><p class="text-sm mb-4">Consult your doctor before using if you have a history of epilepsy or seizures, or if you are concerned about photosensitivity. Use with caution, especially at higher frequencies and contrasts.</p><p class="text-sm mb-6">By clicking "Proceed", you acknowledge that you have read and understood this warning.</p><div class="flex justify-end space-x-3"><button id="cancelWarningButton" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button><button id="proceedWarningButton" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors">Proceed</button></div></div></div>
        <div id="emdrDisclaimerModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden"><div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full"><h3 class="text-xl font-bold text-amber-600 dark:text-amber-400 mb-4 text-center">Important Disclaimer</h3><p class="text-sm mb-2">This exercise guides bilateral eye movements, and is one component of Eye Movement Desensitization and Reprocessing (EMDR).</p><p class="text-sm mb-4">This is only a component of EMDR, and does not replace therapy.</p><p class="text-sm mb-6">This tool is intended for general relaxation or focus only. By clicking "Proceed", you acknowledge that you have read and understood this disclaimer.</p><div class="flex justify-end space-x-3"><button id="cancelDisclaimerButton" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button><button id="proceedDisclaimerButton" class="px-4 py-2 text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 rounded-lg transition-colors">Proceed</button></div></div></div>
        <div id="audioDisclaimerModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden"><div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full"><h3 id="audioDisclaimerTitle" class="text-xl font-bold text-purple-600 dark:text-purple-400 mb-4 text-center">Headphone Recommendation</h3><p id="audioDisclaimerText" class="text-sm mb-4">For the best binaural beat effect, please use stereo headphones. This allows the slightly different frequencies to be delivered independently to each ear.</p><p class="text-sm mb-6">By clicking "Proceed", you acknowledge this recommendation.</p><div class="flex justify-end space-x-3"><button id="cancelAudioDisclaimerButton" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button><button id="proceedAudioDisclaimerButton" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors">Proceed</button></div></div></div>

        <!-- Module Info Modals -->
        <div id="breathingInfoModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div id="breathingInfoModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full z-10">
                <h3 class="text-xl font-bold mb-4 text-center">About Breathing Control</h3>
                <div class="space-y-4 text-sm">
                    <p>Controlled breathing, or paced respiration, is a core technique for managing the body's stress response. By consciously slowing your breathing rate, you can influence your autonomic nervous system, shifting it from a state of "fight or flight" (sympathetic) to "rest and digest" (parasympathetic).</p>
                    <p>This technique can help lower heart rate, reduce blood pressure, and calm feelings of anxiety or panic.</p>
                    <div>
                        <h4 class="font-semibold mb-2">Further Reading:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li><a href="https://www.health.harvard.edu/mind-and-mood/relaxation-techniques-breath-control-helps-quell-errant-stress-response" target="_blank" rel="noopener noreferrer">Harvard Health on Breath Control</a></li>
                            <li><a href="https://www.verywellmind.com/box-breathing-4159900" target="_blank" rel="noopener noreferrer">How to Practice Box Breathing</a></li>
                            <li><a href="https://www.medicalnewstoday.com/articles/301587" target="_blank" rel="noopener noreferrer">What is the Vagus Nerve?</a></li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeBreathingInfoBtn" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="visualInfoModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div id="visualInfoModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full z-10">
                <h3 class="text-xl font-bold mb-4 text-center">About Visual Entrainment</h3>
                <div class="space-y-4 text-sm">
                    <p>Visual entrainment, or photic stimulation, uses rhythmic light to encourage the brain's electrical activity (brainwaves) to synchronize with the stimulus frequency. Different frequencies are associated with different mental states (e.g., Alpha for relaxation, Beta for focus).</p>
                    <p class="font-semibold text-red-500 dark:text-red-400">Warning: This technique involves flashing lights and should be used with extreme caution. It may be dangerous for individuals with photosensitive epilepsy. Consult a doctor if you have any concerns.</p>
                    <div>
                        <h4 class="font-semibold mb-2">Further Reading:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li><a href="https://www.researchgate.net/publication/329796329_A_Review_of_Photic_Driving_and_its_Effect_on_the_Human_Brain" target="_blank" rel="noopener noreferrer">A Review of Photic Driving (ResearchGate)</a></li>
                            <li><a href="https://en.wikipedia.org/wiki/Brainwave_entrainment" target="_blank" rel="noopener noreferrer">Brainwave Entrainment (Wikipedia)</a></li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeVisualInfoBtn" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="eyeMovementInfoModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div id="eyeMovementInfoModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full z-10">
                <h3 class="text-xl font-bold mb-4 text-center">About Guided Eye Movement</h3>
                <div class="space-y-4 text-sm">
                    <p>This exercise uses bilateral stimulation by having you track a moving object with your eyes. It's a core component of Eye Movement Desensitization and Reprocessing (EMDR) therapy. While this tool is not a substitute for therapy, practicing guided eye movements can promote relaxation and help integrate thoughts by engaging both brain hemispheres.</p>
                     <p class="font-semibold text-amber-600 dark:text-amber-400">Disclaimer: This tool is for general relaxation and focus only. It is not a therapeutic tool and does not replace professional therapy with a licensed EMDR practitioner.</p>
                    <div>
                        <h4 class="font-semibold mb-2">Further Reading:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li><a href="https://www.emdr.com/what-is-emdr/" target="_blank" rel="noopener noreferrer">What is EMDR? (EMDR Institute, Inc.)</a></li>
                            <li><a href="https://www.verywellmind.com/bilateral-stimulation-in-emdr-therapy-5213693" target="_blank" rel="noopener noreferrer">Bilateral Stimulation in Therapy (Verywell Mind)</a></li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeEyeMovementInfoBtn" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="audioInfoModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 hidden">
            <div id="audioInfoModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-70"></div>
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full z-10">
                <h3 class="text-xl font-bold mb-4 text-center">About Auditory Entrainment</h3>
                <div class="space-y-4 text-sm">
                    <p>This technique uses sound to influence brainwave patterns. <br> &bull; <b>Binaural Beats:</b> Require stereo headphones to present slightly different frequencies to each ear. The brain perceives the difference as a rhythmic "beat." <br> &bull; <b>Isochronic Tones:</b> Use a single tone that is rapidly turned on and off, creating a distinct pulse that does not require headphones.</p>
                    <p>Users listen to these tones to help induce states of relaxation (Delta/Theta waves), meditation (Alpha waves), or focus (Beta/Gamma waves).</p>
                    <div>
                        <h4 class="font-semibold mb-2">Further Reading:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li><a href="https://www.healthline.com/health/binaural-beats" target="_blank" rel="noopener noreferrer">Binaural Beats: Benefits and How They Work (Healthline)</a></li>
                            <li><a href="https://www.psychologytoday.com/us/blog/sleep-new-york/202108/auditory-brainwave-entrainment-overview" target="_blank"rel="noopener noreferrer">Auditory Brainwave Entrainment (Psychology Today)</a></li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeAudioInfoBtn" class="px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="mobileAudioActivationModal" class="fixed inset-0 z-[2100] flex items-center justify-center p-4 hidden">
            <div class="modal-content p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold text-purple-600 dark:text-purple-400 mb-4 text-center">Enable Audio</h3>
                <p class="text-sm mb-4">Mobile devices require explicit user interaction to enable audio playback.</p>
                <p class="text-sm mb-2">Please tap the button below to enable audio for this session:</p>
                <button id="enableMobileAudioButton" class="mt-4 w-full py-4 px-4 text-lg font-semibold text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 010-7.072m12.728 2.828a9 9 0 010-12.728M3 9.879l-1.415 1.415a1 1 0 01-1.414-1.414l2.828-2.829a1 1 0 011.414 0l2.829 2.829a1 1 0 01-1.414 1.414L4.121 9.879M3 14.121l-1.415-1.415a1 1 0 00-1.414 1.414l2.828 2.829a1 1 0 001.414 0l2.829-2.829a1 1 0 00-1.414-1.414L4.121 14.121" />
                    </svg>
                    Tap to Enable Audio
                </button>
                <div id="audioTestArea" class="mt-6 text-center hidden">
                    <p class="text-sm mb-2">Test your audio:</p>
                    <button id="testAudioButton" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors">
                        Play Test Sound
                    </button>
                    <p id="audioTestResult" class="mt-2 text-sm"></p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="closeMobileAudioModalButton" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State & Config ---
        let currentModule = null;
        let wakeLockSentinel = null;
        let currentUser = null; 
        let moodChart = null;
        let pendingSessionStart = null;
        let pendingSessionEnd = null;
        let currentTheme = 'light';
        let audioContext = null;
        let mobileAudioEnabled = false;
        
        // --- Question Configuration ---
        const moodQuestions = [
            {
                id: 'calmness',
                text: 'How <b>calm</b> do you feel right now?',
                labels: ['(1) Not at all', '(2)', '(3) Moderately', '(4)', '(5) Very much']
            }
        ];
        let currentQuestion = moodQuestions[0];

        // --- DOM Cache ---
        const dom = {
            body: document.body,
            themeToggle: document.getElementById('themeToggle'),
            firstTimeUserGuideModal: document.getElementById('firstTimeUserGuideModal'),
            closeUserGuideButton: document.getElementById('closeUserGuideButton'),
            moodMeasureCheckbox: document.getElementById('moodMeasureCheckbox'),
            moodQuestionnaireModal: document.getElementById('moodQuestionnaireModal'),
            moodForm: document.getElementById('moodForm'),
            mainAppWrapper: document.getElementById('mainAppWrapper'),
            mainAppHeader: document.getElementById('mainAppHeader'),
            dashboard: document.getElementById('dashboard'),
            wellnessHub: document.getElementById('wellnessHub'),
            authContainer: document.getElementById('auth-container'),
            authModal: document.getElementById('authModal'),
            authModalOverlay: document.getElementById('authModalOverlay'),
            closeAuthModalBtn: document.getElementById('closeAuthModal'),
            authTabs: document.querySelectorAll('.auth-tab'),
            authForms: document.querySelectorAll('.auth-form'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginErrorEl: document.getElementById('loginError'),
            registerErrorEl: document.getElementById('registerError'),
            sessionHistoryTableBody: document.getElementById('sessionHistoryTableBody'),
            moduleCards: document.querySelectorAll('.module-card'),
            backToDashboardBtns: document.querySelectorAll('.back-to-dashboard-btn'),
            allSections: document.querySelectorAll('.app-section'),
            disclaimerModals: {
                visual: document.getElementById('photosensitivityWarningModal'),
                eyeMovement: document.getElementById('emdrDisclaimerModal'),
                audio: document.getElementById('audioDisclaimerModal')
            },
            resetConfirmationModal: document.getElementById('resetConfirmationModal'),
            resetProgressBtn: document.getElementById('resetProgressBtn'),
            downloadProgressBtn: document.getElementById('downloadProgressBtn'),
            confirmResetBtn: document.getElementById('confirmResetBtn'),
            cancelResetBtn: document.getElementById('cancelResetBtn')
        };
        
        // --- Utility Functions ---
        function getContrastingTextColor(hexColor) {
            if (!hexColor || hexColor.length < 4) return (currentTheme === 'dark' ? '#f9fafb' : '#111827');
            let r, g, b;
            if (hexColor.length === 4) {
                r = parseInt(hexColor[1] + hexColor[1], 16);
                g = parseInt(hexColor[2] + hexColor[2], 16);
                b = parseInt(hexColor[3] + hexColor[3], 16);
            } else {
                r = parseInt(hexColor.slice(1, 3), 16);
                g = parseInt(hexColor.slice(3, 5), 16);
                b = parseInt(hexColor.slice(5, 7), 16);
            }
            const lumR = r / 255 <= 0.03928 ? r / 255 / 12.92 : Math.pow(((r / 255) + 0.055) / 1.055, 2.4);
            const lumG = g / 255 <= 0.03928 ? g / 255 / 12.92 : Math.pow(((g / 255) + 0.055) / 1.055, 2.4);
            const lumB = b / 255 <= 0.03928 ? b / 255 / 12.92 : Math.pow(((b / 255) + 0.055) / 1.055, 2.4);
            const luminance = 0.2126 * lumR + 0.7152 * lumG + 0.0722 * lumB;
            return luminance > 0.4 ? '#111827' : '#f9fafb';
        }

        function updateTextElementAppearance(element, backgroundColorHex) {
            if (!element) return;
            const textColor = getContrastingTextColor(backgroundColorHex);
            element.style.color = textColor;
        }

        function createAudioContext() {
            if (!audioContext || audioContext.state === 'closed') {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) { return false; }
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(() => false);
            }
            return true;
        }

        // Pink noise generator using white noise and filtering
        function createPinkNoiseNode(audioContext) {
            const bufferSize = 4096;
            const pinkNoise = audioContext.createScriptProcessor(bufferSize, 0, 1);
            
            // Pink noise filter coefficients (approximation)
            let b0, b1, b2, b3, b4, b5, b6;
            b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
            
            pinkNoise.onaudioprocess = function(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    output[i] *= 0.11; // Scale down
                    b6 = white * 0.115926;
                }
            };
            
            return pinkNoise;
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768);
        }

        // --- Base Module Class ---
        class BaseModule {
            constructor(name, elements) {
                this.name = name;
                this.elements = elements;
                this.animationFrameId = null;
                this.timerIntervalId = null;
                this.sessionEndTime = 0;
                this.preSessionMood = null;
                // Bind the functions once and store the references
                this.boundHandleGlobalEscapeKey = this.handleGlobalEscapeKey.bind(this);
                this.boundLoopAnimation = this.loopAnimation.bind(this);

                this.elements.quitBtn.addEventListener('click', () => this.stop('Session stopped by user.'));
            }

            // --- Core Session Flow ---
            async start() {
                if (currentModule) return;
                currentModule = this;

                const preChecksPassed = await this.runPreChecks();
                if (!preChecksPassed) {
                    currentModule = null;
                    return;
                }

                if (dom.moodMeasureCheckbox.checked && currentUser) {
                    this.askPreSessionMood((mood) => {
                        this.preSessionMood = mood;
                        this.beginSession();
                    });
                } else {
                    this.beginSession();
                }
            }
            
            async runPreChecks() {
                // To be overridden by child classes if they have disclaimers
                return true;
            }

            beginSession() {
                this.showModuleUI();
                this.startTimer();
                this.startAnimation();
                this.acquireWakeLock();
                document.addEventListener('keydown', this.boundHandleGlobalEscapeKey);
            }

            stop(message) {
                if (!currentModule) return; // Prevent multiple calls
                const wasCompleted = message === "Session Complete!";
                this.stopAnimation();
                this.stopTimer();
                this.releaseWakeLock();
                document.removeEventListener('keydown', this.boundHandleGlobalEscapeKey);

                if (dom.moodMeasureCheckbox.checked && currentUser && wasCompleted) {
                    this.askPostSessionMood((mood) => {
                        this.finalizeSession(message, mood);
                    });
                } else {
                    this.finalizeSession(message, null);
                }
            }

            finalizeSession(message, postSessionMood) {
                this.hideModuleUI();
                this.elements.messageArea.textContent = message;

                if (message === "Session Complete!") {
                    const sessionData = {
                        moduleType: this.getModuleName(),
                        duration: this.getDuration(),
                        settings: this.getSettings(),
                        mood: { pre: this.preSessionMood, post: postSessionMood }
                    };
                    saveSession(sessionData);
                }
                
                setTimeout(() => {
                    this.elements.settingsPanel.classList.remove('hidden');
                    this.elements.animationArea.classList.add('hidden');
                    this.elements.animationArea.classList.remove('flex');
                    this.resetModuleState();
                }, message === "Session stopped by user." ? 500 : 3000);
                
                currentModule = null;
            }

            // --- Abstract Methods (to be implemented by child classes) ---
            startAnimation() { throw new Error("startAnimation() must be implemented."); }
            updateAnimation() { /* Optional override */ }
            stopAnimation() {
                 if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                 this.animationFrameId = null;
            }
            getSettings() { throw new Error("getSettings() must be implemented."); }
            getModuleName() { throw new Error("getModuleName() must be implemented."); }
            getDuration() { throw new Error("getDuration() must be implemented."); }
            resetModuleState() { /* Optional override */ }


            // --- Common Helper Methods ---
            showModuleUI() {
                dom.allSections.forEach(s => s.classList.add('hidden'));
                this.elements.section.classList.remove('hidden');
                this.elements.settingsPanel.classList.add('hidden');
                this.elements.animationArea.classList.remove('hidden');
                this.elements.animationArea.classList.add('flex');
                
                this.enterFullscreen();
            }
            
            hideModuleUI() {
                this.exitFullscreen();
                const backBtn = this.elements.section.querySelector('.back-to-dashboard-btn');
                if (backBtn) backBtn.classList.remove('hidden');
            }

            enterFullscreen() {
                dom.body.classList.add('body-no-scroll');
                dom.mainAppHeader.classList.add('hidden');
                this.elements.animationArea.classList.add('fullscreen-module');
                this.elements.animationArea.classList.remove('max-w-md', 'mx-auto', 'my-8', 'rounded-xl', 'shadow-xl');
                this.elements.timerDisplay.classList.add('fullscreen-timer');
                this.elements.quitBtn.classList.add('fullscreen-quit-btn');
                if(this.elements.phaseIndicator) this.elements.phaseIndicator.classList.add('fullscreen-phase-indicator');
            }
            
            exitFullscreen() {
                dom.body.classList.remove('body-no-scroll');
                dom.mainAppHeader.classList.remove('hidden');
                this.elements.animationArea.classList.remove('fullscreen-module');
                this.elements.animationArea.classList.add('max-w-md', 'mx-auto', 'my-8', 'rounded-xl', 'shadow-xl');
                this.elements.timerDisplay.classList.remove('fullscreen-timer');
                this.elements.quitBtn.classList.remove('fullscreen-quit-btn');
                if(this.elements.phaseIndicator) this.elements.phaseIndicator.classList.remove('fullscreen-phase-indicator');
            }

            loopAnimation() {
                this.updateAnimation();
                this.animationFrameId = requestAnimationFrame(this.boundLoopAnimation);
            }

            startTimer() {
                const durationMinutes = this.getDuration();
                if (isNaN(durationMinutes) || durationMinutes <=0) {
                    this.elements.messageArea.textContent = "Please set a valid duration.";
                    this.stop("Invalid duration.");
                    return;
                }
                this.sessionEndTime = Date.now() + durationMinutes * 60 * 1000;
                this.updateTimerDisplay();
                this.timerIntervalId = setInterval(() => {
                    this.updateTimerDisplay();
                    if (Date.now() >= this.sessionEndTime && this.timerIntervalId) {
                       this.stop("Session Complete!");
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timerIntervalId) clearInterval(this.timerIntervalId);
                this.timerIntervalId = null;
            }

            updateTimerDisplay() {
                const now = Date.now();
                const timeLeftMs = Math.max(0, this.sessionEndTime - now);
                const minutes = String(Math.floor(timeLeftMs / 60000)).padStart(2, '0');
                const seconds = String(Math.floor((timeLeftMs % 60000) / 1000)).padStart(2, '0');
                this.elements.timerDisplay.textContent = `${minutes}:${seconds}`;
            }

            askPreSessionMood(callback) {
                pendingSessionStart = callback;
                populateQuestionnaire();
                dom.moodQuestionnaireModal.classList.remove('hidden');
                dom.moodQuestionnaireModal.classList.add('flex');
            }

            askPostSessionMood(callback) {
                pendingSessionEnd = callback;
                populateQuestionnaire();
                dom.moodQuestionnaireModal.classList.remove('hidden');
                dom.moodQuestionnaireModal.classList.add('flex');
            }
            
            handleGlobalEscapeKey(event) {
                if (event.key.toLowerCase() === 'q') {
                    this.stop("Session stopped by user.");
                }
            }

            async acquireWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLockSentinel = await navigator.wakeLock.request('screen');
                    } catch (err) { console.error(`${err.name}, ${err.message}`); }
                }
            }

            async releaseWakeLock() {
                if (wakeLockSentinel) {
                    await wakeLockSentinel.release();
                    wakeLockSentinel = null;
                }
            }
        }

        // --- Breathing Module ---
        class BreathingModule extends BaseModule {
            constructor() {
                super('breathing', {
                    section: document.getElementById('breathingControlApp'),
                    settingsPanel: document.getElementById('breathingSettingsPanel'),
                    animationArea: document.getElementById('breathingArea'),
                    timerDisplay: document.getElementById('breathingTimerDisplay'),
                    messageArea: document.getElementById('breathingMessageArea'),
                    quitBtn: document.querySelector('#breathingArea .quit-module-btn'),
                    phaseIndicator: document.getElementById('breathingPhaseIndicator'),
                    circle: document.getElementById('breathingCircle'),
                    durationInput: document.getElementById('breathingDuration'),
                    inhaleInput: document.getElementById('inhaleDuration'),
                    holdInput: document.getElementById('holdDuration'),
                    exhaleInput: document.getElementById('exhaleDuration'),
                    holdAfterExhaleInput: document.getElementById('holdAfterExhaleDuration'),
                    colorInput: document.getElementById('circleColor'),
                    bgColorInput: document.getElementById('breathingBgColor')
                });
                this.phases = [];
                this.currentPhaseIndex = 0;
                this.phaseStartTime = 0;

                this.elements.inhaleInput.addEventListener('change', () => this.saveSettings());
                this.elements.holdInput.addEventListener('change', () => this.saveSettings());
                this.elements.exhaleInput.addEventListener('change', () => this.saveSettings());
                this.elements.holdAfterExhaleInput.addEventListener('change', () => this.saveSettings());
            }

            getModuleName() { return 'Breathing Control'; }
            getDuration() { return parseInt(this.elements.durationInput.value); }
            
            getSettings() {
                return {
                    inhale: parseInt(this.elements.inhaleInput.value),
                    hold: parseInt(this.elements.holdInput.value),
                    exhale: parseInt(this.elements.exhaleInput.value),
                    holdAfterExhale: parseInt(this.elements.holdAfterExhaleInput.value)
                };
            }

            saveSettings() {
                const settings = this.getSettings();
                localStorage.setItem('breathingSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const savedSettings = JSON.parse(localStorage.getItem('breathingSettings'));
                if (savedSettings) {
                    this.elements.inhaleInput.value = savedSettings.inhale || 4;
                    this.elements.holdInput.value = savedSettings.hold || 2;
                    this.elements.exhaleInput.value = savedSettings.exhale || 4;
                    this.elements.holdAfterExhaleInput.value = savedSettings.holdAfterExhale || 2;
                }
            }

            startAnimation() {
                const { bgColorInput, colorInput } = this.elements;
                const settings = this.getSettings();

                this.phases = [
                    { name: 'Inhale', duration: settings.inhale * 1000, scale: 1.3 },
                    { name: 'Hold', duration: settings.hold * 1000, scale: 1.3 },
                    { name: 'Exhale', duration: settings.exhale * 1000, scale: 0.7 },
                    { name: 'Hold', duration: settings.holdAfterExhale * 1000, scale: 0.7 },
                ];
                // Filter out phases with zero duration
                this.phases = this.phases.filter(p => p.duration > 0);

                if (this.phases.length === 0) {
                    this.stop("Invalid phase durations.");
                    return;
                }

                const bgColor = bgColorInput.value;
                this.elements.animationArea.style.backgroundColor = bgColor;
                updateTextElementAppearance(this.elements.timerDisplay, bgColor);
                updateTextElementAppearance(this.elements.quitBtn, bgColor);
                updateTextElementAppearance(this.elements.phaseIndicator, bgColor);

                this.currentPhaseIndex = 0;
                this.phaseStartTime = Date.now();
                this.updatePhase(true);

                this.loopAnimation();
            }

            updateAnimation() {
                const now = Date.now();
                const currentPhase = this.phases[this.currentPhaseIndex];
                if (now - this.phaseStartTime >= currentPhase.duration) {
                    this.phaseStartTime = now;
                    this.currentPhaseIndex = (this.currentPhaseIndex + 1) % this.phases.length;
                    this.updatePhase(false);
                }
            }

            updatePhase(isFirstPhase) {
                const { circle, phaseIndicator } = this.elements;
                const newPhase = this.phases[this.currentPhaseIndex];

                phaseIndicator.textContent = newPhase.name;
                circle.style.transform = `scale(${newPhase.scale})`;
                
                if (isFirstPhase) {
                     circle.style.backgroundColor = this.elements.colorInput.value;
                     circle.style.transition = `transform ${newPhase.duration / 1000}s ease-in-out, background-color 0.5s ease`;
                } else {
                    // For subsequent phases, only transition the transform property
                    circle.style.transition = `transform ${newPhase.duration / 1000}s ease-in-out`;
                }
            }
            
            resetModuleState() {
                this.elements.phaseIndicator.textContent = "Prepare...";
                this.elements.circle.style.transform = 'scale(1)';
                this.elements.circle.style.backgroundColor = this.elements.colorInput.value;
                this.elements.circle.style.transition = 'transform 0.5s ease-in-out, background-color 0.3s ease';
                this.elements.messageArea.textContent = "";
            }
        }
        
        // --- Visual Module ---
        class VisualModule extends BaseModule {
             constructor() {
                 super('visual', {
                    section: document.getElementById('visualEntrainmentApp'),
                    settingsPanel: document.getElementById('visualSettingsPanel'),
                    animationArea: document.getElementById('visualArea'),
                    timerDisplay: document.getElementById('visualTimerDisplay'),
                    messageArea: document.getElementById('visualMessageArea'),
                    quitBtn: document.querySelector('#visualArea .quit-module-btn'),
                    durationInput: document.getElementById('visualDuration'),
                    frequencyInput: document.getElementById('frequency'),
                    sizeInput: document.getElementById('foregroundSize'),
                    transitionInput: document.getElementById('transitionSpeed'),
                    shapeInput: document.getElementById('foregroundShape'),
                    color1Input: document.getElementById('patternColor1'),
                    color2Input: document.getElementById('patternColor2'),
                    shape: document.getElementById('visualShape'),
                 });
                 this.stateDurationMs = 0;
                 this.lastToggleTime = 0;
                 this.patternState = 0;

                 this.elements.frequencyInput.addEventListener('input', () => this.updateValueLabels());
                 this.elements.sizeInput.addEventListener('input', () => this.updateValueLabels());
                 this.elements.transitionInput.addEventListener('input', () => this.updateValueLabels());

                 this.elements.frequencyInput.addEventListener('change', () => this.saveSettings());
                 this.elements.sizeInput.addEventListener('change', () => this.saveSettings());
                 this.elements.transitionInput.addEventListener('change', () => this.saveSettings());
                 this.elements.shapeInput.addEventListener('change', () => this.saveSettings());
                 this.elements.color1Input.addEventListener('change', () => this.saveSettings());
                 this.elements.color2Input.addEventListener('change', () => this.saveSettings());
             }
             
             getModuleName() { return 'Visual Entrainment'; }
             getDuration() { return parseInt(this.elements.durationInput.value); }
             
             getSettings() {
                return {
                    frequency: parseFloat(this.elements.frequencyInput.value),
                    size: parseInt(this.elements.sizeInput.value),
                    transition: parseInt(this.elements.transitionInput.value),
                    shape: this.elements.shapeInput.value,
                    color1: this.elements.color1Input.value,
                    color2: this.elements.color2Input.value,
                };
             }

            saveSettings() {
                const settings = this.getSettings();
                localStorage.setItem('visualSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('visualSettings'));
                if (settings) {
                    this.elements.frequencyInput.value = settings.frequency || 10;
                    this.elements.sizeInput.value = settings.size || 80;
                    this.elements.transitionInput.value = settings.transition || 50;
                    this.elements.shapeInput.value = settings.shape || 'circle';
                    this.elements.color1Input.value = settings.color1 || '#4fd1c5';
                    this.elements.color2Input.value = settings.color2 || '#2d3748';
                }
                this.updateValueLabels();
            }

            updateValueLabels() {
                document.getElementById('frequencyValue').textContent = parseFloat(this.elements.frequencyInput.value).toFixed(1);
                document.getElementById('foregroundSizeValue').textContent = `${this.elements.sizeInput.value}%`;
                document.getElementById('transitionSpeedValue').textContent = `${this.elements.transitionInput.value}%`;
            }

             async runPreChecks() {
                return new Promise(resolve => {
                    const modal = dom.disclaimerModals.visual;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    const proceedBtn = modal.querySelector('#proceedWarningButton');
                    const cancelBtn = modal.querySelector('#cancelWarningButton');

                    const onProceed = () => { cleanup(); resolve(true); };
                    const onCancel = () => { cleanup(); resolve(false); };
                    
                    const cleanup = () => {
                        modal.classList.add('hidden');
                        proceedBtn.removeEventListener('click', onProceed);
                        cancelBtn.removeEventListener('click', onCancel);
                    };
                    
                    proceedBtn.addEventListener('click', onProceed, { once: true });
                    cancelBtn.addEventListener('click', onCancel, { once: true });
                });
             }

             startAnimation() {
                 const settings = this.getSettings();
                 this.stateDurationMs = (1 / settings.frequency / 2) * 1000;
                 
                 const transitionPercentage = settings.transition / 100;
                 // The transition can take up the entire duration of the state.
                 const transitionDurationSeconds = (this.stateDurationMs / 1000) * transitionPercentage;

                 this.elements.shape.style.transition = `background-color ${transitionDurationSeconds}s ease-in-out`;
                 this.elements.animationArea.style.backgroundColor = settings.color2;

                 this.patternState = 0;
                 this.lastToggleTime = Date.now();
                 this.applyStyling();
                 this.loopAnimation();
             }
             
             updateAnimation() {
                 const now = Date.now();
                 if (now - this.lastToggleTime >= this.stateDurationMs) {
                     this.patternState = 1 - this.patternState;
                     this.applyStyling();
                     this.lastToggleTime = now;
                 }
             }

             applyStyling() {
                const settings = this.getSettings();
                const size = settings.size;
                const shape = settings.shape;

                this.elements.shape.style.width = `${size}%`;
                this.elements.shape.style.height = `${size}%`;
                this.elements.shape.style.borderRadius = shape === 'circle' ? '50%' : '0';
                this.elements.shape.style.backgroundColor = this.patternState === 0 ? settings.color1 : settings.color2;
                
                // The animation area background is always color2, text contrast is based on it.
                updateTextElementAppearance(this.elements.timerDisplay, settings.color2);
                updateTextElementAppearance(this.elements.quitBtn, settings.color2);
             }

             resetModuleState() {
                this.elements.shape.style.transition = 'none';
                this.elements.messageArea.textContent = "";
             }
        }
        
        // --- Eye Movement Module ---
        class EyeMovementModule extends BaseModule {
             constructor() {
                 super('eyeMovement', {
                    section: document.getElementById('eyeMovementApp'),
                    settingsPanel: document.getElementById('eyeMovementSettingsPanel'),
                    animationArea: document.getElementById('eyeMovementArea'),
                    timerDisplay: document.getElementById('eyeMovementTimerDisplay'),
                    messageArea: document.getElementById('eyeMovementMessageArea'),
                    quitBtn: document.querySelector('#eyeMovementArea .quit-module-btn'),
                    durationInput: document.getElementById('eyeMovementDuration'),
                    speedInput: document.getElementById('ballSpeed'),
                    sizeInput: document.getElementById('ballSize'),
                    pathSelect: document.getElementById('eyeMovementPath'),
                    pulseSelect: document.getElementById('ballPulse'),
                    ball: document.getElementById('emdrBall'),
                    barLeft: document.getElementById('emdrBarLeft'),
                    barRight: document.getElementById('emdrBarRight'),
                    bgColorInput: document.getElementById('eyeMovementBgColor'),
                    ballColorInput: document.getElementById('ballColor'),
                    barColorInput: document.getElementById('barColor')
                 });
                 this.ballPositionX = 0;
                 this.ballDirection = 1;
                 this.angle = 0;

                 this.elements.speedInput.addEventListener('input', () => this.updateValueLabels());
                 this.elements.sizeInput.addEventListener('input', () => this.updateValueLabels());

                 this.elements.speedInput.addEventListener('change', () => this.saveSettings());
                 this.elements.sizeInput.addEventListener('change', () => this.saveSettings());
                 this.elements.pathSelect.addEventListener('change', () => this.saveSettings());
                 this.elements.pulseSelect.addEventListener('change', () => this.saveSettings());
                 this.elements.bgColorInput.addEventListener('change', () => this.saveSettings());
                 this.elements.ballColorInput.addEventListener('change', () => this.saveSettings());
                 this.elements.barColorInput.addEventListener('change', () => this.saveSettings());
             }
             
             getModuleName() { return 'Guided Eye Movement'; }
             getDuration() { return parseInt(this.elements.durationInput.value); }
             
             getSettings() {
                return {
                    path: this.elements.pathSelect.value,
                    speed: parseFloat(this.elements.speedInput.value),
                    size: parseInt(this.elements.sizeInput.value),
                    pulse: this.elements.pulseSelect.value,
                    bgColor: this.elements.bgColorInput.value,
                    ballColor: this.elements.ballColorInput.value,
                    barColor: this.elements.barColorInput.value,
                };
             }

            saveSettings() {
                const settings = this.getSettings();
                localStorage.setItem('eyeMovementSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('eyeMovementSettings'));
                if (settings) {
                    this.elements.pathSelect.value = settings.path || 'horizontal';
                    this.elements.speedInput.value = settings.speed || 5;
                    this.elements.sizeInput.value = settings.size || 24;
                    this.elements.pulseSelect.value = settings.pulse || 'none';
                    this.elements.bgColorInput.value = settings.bgColor || '#e0e7ff';
                    this.elements.ballColorInput.value = settings.ballColor || '#818cf8';
                    this.elements.barColorInput.value = settings.barColor || '#4338ca';
                }
                this.updateValueLabels();
            }

            updateValueLabels() {
                document.getElementById('ballSpeedValue').textContent = parseFloat(this.elements.speedInput.value).toFixed(1);
                document.getElementById('ballSizeValue').textContent = `${this.elements.sizeInput.value}px`;
            }

             async runPreChecks() {
                 return new Promise(resolve => {
                    const modal = dom.disclaimerModals.eyeMovement;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    const proceedBtn = modal.querySelector('#proceedDisclaimerButton');
                    const cancelBtn = modal.querySelector('#cancelDisclaimerButton');

                    const onProceed = () => { cleanup(); resolve(true); };
                    const onCancel = () => { cleanup(); resolve(false); };
                    const cleanup = () => {
                        modal.classList.add('hidden');
                        proceedBtn.removeEventListener('click', onProceed);
                        cancelBtn.removeEventListener('click', onCancel);
                    };
                    
                    proceedBtn.addEventListener('click', onProceed, { once: true });
                    cancelBtn.addEventListener('click', onCancel, { once: true });
                });
             }
             
             startAnimation() {
                const settings = this.getSettings();
                this.elements.animationArea.style.backgroundColor = settings.bgColor;
                updateTextElementAppearance(this.elements.timerDisplay, settings.bgColor);
                updateTextElementAppearance(this.elements.quitBtn, settings.bgColor);
                
                this.elements.ball.style.backgroundColor = settings.ballColor;
                this.elements.ball.style.width = `${settings.size}px`;
                this.elements.ball.style.height = `${settings.size}px`;

                this.elements.barLeft.style.backgroundColor = settings.barColor;
                this.elements.barRight.style.backgroundColor = settings.barColor;

                this.ballPositionX = this.elements.barLeft.offsetWidth;
                this.elements.ball.style.left = `${this.ballPositionX}px`;
                this.elements.ball.style.top = `50%`;
                this.elements.ball.style.transform = `translateY(-50%)`;
                this.ballDirection = 1;
                this.angle = 0;
                this.loopAnimation();
             }
             
             updateAnimation() {
                const settings = this.getSettings();
                const areaWidth = this.elements.animationArea.clientWidth;
                const areaHeight = this.elements.animationArea.clientHeight;
                const ballWidth = this.elements.ball.offsetWidth;
                const ballHeight = this.elements.ball.offsetHeight;
                const speed = settings.speed / 2;
                
                let transformString = '';

                if (settings.path === 'horizontal') {
                    this.elements.barLeft.classList.remove('hidden');
                    this.elements.barRight.classList.remove('hidden');
                    this.elements.ball.style.top = `50%`;
                    transformString = 'translateY(-50%)';
                    
                    const minX = this.elements.barLeft.offsetWidth;
                    const maxX = areaWidth - this.elements.barRight.offsetWidth - ballWidth;
                    this.ballPositionX += this.ballDirection * speed * (areaWidth / 300);

                    if (this.ballPositionX >= maxX) { this.ballPositionX = maxX; this.ballDirection = -1; }
                    else if (this.ballPositionX <= minX) { this.ballPositionX = minX; this.ballDirection = 1; }
                    this.elements.ball.style.left = `${this.ballPositionX}px`;
                } else {
                    this.elements.barLeft.classList.add('hidden');
                    this.elements.barRight.classList.add('hidden');
                    const centerX = areaWidth / 2;
                    const centerY = areaHeight / 2;
                    const radiusX = (areaWidth - ballWidth) / 2 * 0.9;
                    const radiusY = (areaHeight - ballHeight) / 2 * 0.9;
                    this.angle += speed / 100;
                    let newX, newY;

                    if (settings.path === 'circular') {
                        newX = centerX + radiusX * Math.cos(this.angle) - (ballWidth / 2);
                        newY = centerY + radiusY * Math.sin(this.angle) - (ballHeight / 2);
                    } else if (settings.path === 'figureEight') {
                        newX = centerX + radiusX * Math.sin(this.angle) - (ballWidth / 2);
                        newY = centerY + radiusY * Math.sin(this.angle) * Math.cos(this.angle) - (ballHeight / 2);
                    }
                    this.elements.ball.style.left = `${newX}px`;
                    this.elements.ball.style.top = `${newY}px`;
                    transformString = 'translate(0,0)';
                }

                if (settings.pulse === 'subtle') {
                    const pulseScale = 1 + Math.sin(Date.now() / 300) * 0.08; // Reduced intensity
                    transformString += ` scale(${pulseScale})`;
                }

                this.elements.ball.style.transform = transformString;
             }

             resetModuleState() {
                this.elements.barLeft.classList.remove('hidden');
                this.elements.barRight.classList.remove('hidden');
                this.elements.ball.style.transform = `translateY(-50%) scale(1)`;
                this.elements.messageArea.textContent = "";
             }
        }

        // --- Audio Module ---
        class AudioModule extends BaseModule {
            constructor() {
                super('audio', {
                    section: document.getElementById('audioEntrainmentApp'),
                    settingsPanel: document.getElementById('audioSettingsPanel'),
                    animationArea: document.getElementById('audioArea'),
                    timerDisplay: document.getElementById('audioTimerDisplay'),
                    messageArea: document.getElementById('audioMessageArea'),
                    quitBtn: document.querySelector('#audioArea .quit-module-btn'),
                    durationInput: document.getElementById('audioDuration'),
                    toneTypeSelect: document.getElementById('toneType'),
                    carrierFreqInput: document.getElementById('carrierFrequencyControl'),
                    beatFreqInput: document.getElementById('beatFrequencyControl'),
                    displayText: document.getElementById('audioDisplayText'),
                    pinkNoiseCheckbox: document.getElementById('pinkNoiseEnabled'),
                    pinkNoiseVolumeControl: document.getElementById('pinkNoiseVolumeControl'),
                    pinkNoiseVolumeInput: document.getElementById('pinkNoiseVolume'),
                    pinkNoiseSection: document.getElementById('pinkNoiseSection'),
                });
                this.leftOscillator = null;
                this.rightOscillator = null;
                this.mainOscillator = null;
                this.pulseGainNode = null;
                this.pulseIntervalId = null;
                this.pinkNoiseNode = null;
                this.pinkNoiseGainNode = null;

                // Add event listeners
                this.elements.carrierFreqInput.addEventListener('input', () => this.updateValueLabels());
                this.elements.beatFreqInput.addEventListener('input', () => this.updateValueLabels());
                this.elements.toneTypeSelect.addEventListener('change', () => this.updateToneTypeLabels());
                this.elements.pinkNoiseCheckbox.addEventListener('change', () => this.togglePinkNoiseControls());
                this.elements.pinkNoiseVolumeInput.addEventListener('input', () => this.updatePinkNoiseVolumeLabel());
                
                // Initialize UI state
                this.updateToneTypeLabels();
                this.togglePinkNoiseControls();
                this.updatePinkNoiseVolumeLabel();
            }

            getModuleName() { return 'Auditory Entrainment'; }
            getDuration() { return parseInt(this.elements.durationInput.value); }
            getSettings() {
                const toneType = this.elements.toneTypeSelect.value;
                return {
                    type: toneType,
                    carrierHz: parseFloat(this.elements.carrierFreqInput.value),
                    beatHz: parseFloat(this.elements.beatFreqInput.value),
                    pinkNoiseEnabled: toneType === 'pinknoise' || this.elements.pinkNoiseCheckbox.checked,
                    pinkNoiseVolume: parseFloat(this.elements.pinkNoiseVolumeInput.value) / 100
                };
            }

            async runPreChecks() {
                 if (isMobileDevice() && !mobileAudioEnabled) {
                    showMobileAudioActivationModal();
                    return false; // Wait for user to enable audio via modal
                 }
                return new Promise(resolve => {
                    const modal = dom.disclaimerModals.audio;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    const proceedBtn = modal.querySelector('#proceedAudioDisclaimerButton');
                    const cancelBtn = modal.querySelector('#cancelAudioDisclaimerButton');

                    const onProceed = () => { cleanup(); resolve(true); };
                    const onCancel = () => { cleanup(); resolve(false); };
                    const cleanup = () => {
                        modal.classList.add('hidden');
                        proceedBtn.removeEventListener('click', onProceed);
                        cancelBtn.removeEventListener('click', onCancel);
                    };
                    
                    proceedBtn.addEventListener('click', onProceed, { once: true });
                    cancelBtn.addEventListener('click', onCancel, { once: true });
                });
            }

            startAnimation() {
                createAudioContext();
                if (!audioContext || audioContext.state !== 'running') {
                    this.elements.messageArea.textContent = "Could not start audio. Please interact with the page and try again.";
                    this.stop("Audio failed to start.");
                    return;
                }
                const settings = this.getSettings();
                this.stopAnimation(); // Stop any previous tones

                // Start pink noise if enabled
                if (settings.pinkNoiseEnabled) {
                    this.pinkNoiseNode = createPinkNoiseNode(audioContext);
                    this.pinkNoiseGainNode = audioContext.createGain();
                    this.pinkNoiseGainNode.gain.value = settings.pinkNoiseVolume;
                    this.pinkNoiseNode.connect(this.pinkNoiseGainNode).connect(audioContext.destination);
                }

                if (settings.type === 'binaural') {
                    const displayText = settings.pinkNoiseEnabled ? "Playing Binaural Tones with Pink Noise..." : "Playing Binaural Tones...";
                    this.elements.displayText.textContent = displayText;
                    this.leftOscillator = this.createOscillator(settings.carrierHz, -1);
                    this.rightOscillator = this.createOscillator(settings.carrierHz - settings.beatHz, 1);
                    this.leftOscillator.start();
                    this.rightOscillator.start();
                } else if (settings.type === 'isochronic') {
                    const displayText = settings.pinkNoiseEnabled ? "Playing Rhythmic Pulses with Pink Noise..." : "Playing Rhythmic Pulses...";
                    this.elements.displayText.textContent = displayText;
                    this.mainOscillator = this.createOscillator(settings.carrierHz);
                    this.pulseGainNode = audioContext.createGain();
                    this.pulseGainNode.gain.value = 0.0001;
                    this.mainOscillator.connect(this.pulseGainNode).connect(audioContext.destination);
                    this.mainOscillator.start();

                    const pulsePeriodMs = 1000 / settings.beatHz;
                    this.pulseIntervalId = setInterval(() => {
                        if(!this.pulseGainNode) return;
                        const now = audioContext.currentTime;
                        const gain = this.pulseGainNode.gain;
                        gain.setValueAtTime(gain.value, now);
                        gain.linearRampToValueAtTime(gain.value > 0.1 ? 0.0001 : 0.5, now + 0.01);
                    }, pulsePeriodMs / 2);
                } else if (settings.type === 'pinknoise') {
                    this.elements.displayText.textContent = "Playing Pink Noise...";
                    // Pink noise is already started above, no additional tones needed
                }
            }
            
            updateAnimation() {
                // Noop for audio, handled by Web Audio API and setInterval
            }

            createOscillator(freq, panValue) {
                const osc = audioContext.createOscillator();
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                osc.type = 'sine';
                if (panValue !== undefined && audioContext.createStereoPanner) {
                    const panner = audioContext.createStereoPanner();
                    panner.pan.setValueAtTime(panValue, audioContext.currentTime);
                    osc.connect(panner).connect(audioContext.destination);
                } else {
                    osc.connect(audioContext.destination);
                }
                return osc;
            }

            stopAnimation() {
                if (this.leftOscillator) { this.leftOscillator.stop(); this.leftOscillator = null; }
                if (this.rightOscillator) { this.rightOscillator.stop(); this.rightOscillator = null; }
                if (this.mainOscillator) { this.mainOscillator.stop(); this.mainOscillator = null; }
                if (this.pulseGainNode) { this.pulseGainNode.disconnect(); this.pulseGainNode = null; }
                if (this.pulseIntervalId) { clearInterval(this.pulseIntervalId); this.pulseIntervalId = null; }
                if (this.pinkNoiseNode) { this.pinkNoiseNode.disconnect(); this.pinkNoiseNode = null; }
                if (this.pinkNoiseGainNode) { this.pinkNoiseGainNode.disconnect(); this.pinkNoiseGainNode = null; }
            }

            resetModuleState() {
                this.elements.displayText.textContent = "";
                this.elements.messageArea.textContent = "";
            }

            updateValueLabels() {
                document.getElementById('carrierFreqValueDisplay').textContent = parseFloat(this.elements.carrierFreqInput.value).toFixed(1);
                document.getElementById('beatFreqValueDisplay').textContent = parseFloat(this.elements.beatFreqInput.value).toFixed(1);
            }

            updateToneTypeLabels() {
                const toneType = this.elements.toneTypeSelect.value;
                const carrierFreqLabel = document.getElementById('carrierFreqLabel');
                const baseToneFreqLabel = document.getElementById('baseToneFreqLabel');
                const beatFreqLabel = document.getElementById('beatFreqLabel');
                const pulseFreqLabel = document.getElementById('pulseFreqLabel');
                const carrierInfoText = document.getElementById('carrierInfoText');
                const beatInfoText = document.getElementById('beatInfoText');

                // Get the parent divs for carrier and beat frequency controls
                const carrierFreqDiv = this.elements.carrierFreqInput.closest('div');
                const beatFreqDiv = this.elements.beatFreqInput.closest('div');

                if (toneType === 'binaural') {
                    carrierFreqLabel.classList.remove('hidden');
                    baseToneFreqLabel.classList.add('hidden');
                    beatFreqLabel.classList.remove('hidden');
                    pulseFreqLabel.classList.add('hidden');
                    carrierInfoText.textContent = "For Binaural: The base frequency one ear hears. For Isochronic: The frequency of the tone that pulses. Common range: 100-500Hz.";
                    beatInfoText.textContent = "For Binaural: The difference in Hz between ears, perceived as a beat. For Isochronic: The rate of the tone pulses. (e.g., Delta: 1-4Hz, Theta: 4-8Hz, Alpha: 8-12Hz, Beta: 12-30Hz).";
                    carrierFreqDiv.classList.remove('hidden');
                    beatFreqDiv.classList.remove('hidden');
                    this.elements.pinkNoiseSection.classList.remove('hidden');
                } else if (toneType === 'isochronic') {
                    carrierFreqLabel.classList.add('hidden');
                    baseToneFreqLabel.classList.remove('hidden');
                    beatFreqLabel.classList.add('hidden');
                    pulseFreqLabel.classList.remove('hidden');
                    carrierInfoText.textContent = "For Binaural: The base frequency one ear hears. For Isochronic: The frequency of the tone that pulses. Common range: 100-500Hz.";
                    beatInfoText.textContent = "For Binaural: The difference in Hz between ears, perceived as a beat. For Isochronic: The rate of the tone pulses. (e.g., Delta: 1-4Hz, Theta: 4-8Hz, Alpha: 8-12Hz, Beta: 12-30Hz).";
                    carrierFreqDiv.classList.remove('hidden');
                    beatFreqDiv.classList.remove('hidden');
                    this.elements.pinkNoiseSection.classList.remove('hidden');
                } else if (toneType === 'pinknoise') {
                    // Hide frequency controls for pink noise only mode
                    carrierFreqDiv.classList.add('hidden');
                    beatFreqDiv.classList.add('hidden');
                    this.elements.pinkNoiseSection.classList.add('hidden');
                    // Show pink noise volume control directly
                    this.elements.pinkNoiseVolumeControl.classList.remove('hidden');
                }
            }

            togglePinkNoiseControls() {
                const toneType = this.elements.toneTypeSelect.value;
                const isEnabled = this.elements.pinkNoiseCheckbox.checked;
                
                // For pink noise only mode, the volume control is handled in updateToneTypeLabels
                if (toneType === 'pinknoise') {
                    return;
                }
                
                if (isEnabled) {
                    this.elements.pinkNoiseVolumeControl.classList.remove('hidden');
                } else {
                    this.elements.pinkNoiseVolumeControl.classList.add('hidden');
                }
            }

            updatePinkNoiseVolumeLabel() {
                const volume = this.elements.pinkNoiseVolumeInput.value;
                document.getElementById('pinkNoiseVolumeDisplay').textContent = volume + '%';
            }
        }
        

        // --- App Initialization ---
        const modules = {};

        function initializeApp() {
            // Create single instances of each module
            modules.breathing = new BreathingModule();
            modules.visual = new VisualModule();
            modules.eyeMovement = new EyeMovementModule();
            modules.audio = new AudioModule();

            modules.breathing.loadSettings(); // Load saved breathing settings
            modules.visual.loadSettings(); // Load saved visual settings
            modules.eyeMovement.loadSettings(); // Load saved eye movement settings
            
            dom.moduleCards.forEach(card => {
                card.addEventListener('click', () => {
                    const moduleName = card.dataset.module;
                    showModule(moduleName);
                });
            });
            
            // Attach start events to buttons
            document.getElementById('startBreathingButton').addEventListener('click', () => modules.breathing.start());
            document.getElementById('startVisualButton').addEventListener('click', () => modules.visual.start());
            document.getElementById('startEyeMovementButton').addEventListener('click', () => modules.eyeMovement.start());
            document.getElementById('startAudioButton').addEventListener('click', () => modules.audio.start());

            dom.backToDashboardBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const parentSection = button.closest('.app-section');
                    if (parentSection) parentSection.classList.add('hidden');
                    button.classList.add('hidden');
                    showDashboard();
                });
            });
            
            initializeDefaultValues();
            
            dom.themeToggle.addEventListener('change', () => {
                const newTheme = dom.themeToggle.checked ? 'dark' : 'light';
                applyTheme(newTheme);
                localStorage.setItem('biofeedback_theme', newTheme);
            });
            
            dom.moodMeasureCheckbox.addEventListener('change', (e) => {
                if (currentUser) {
                    localStorage.setItem('biofeedback_moodMeasureEnabled', e.target.checked);
                }
            });

             dom.closeAuthModalBtn.addEventListener('click', closeAuthModal);
             dom.authModalOverlay.addEventListener('click', closeAuthModal);
             dom.authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;
                    dom.authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    dom.authForms.forEach(form => {
                        form.classList.remove('active');
                        if (form.id === `${target}Form`) {
                            form.classList.add('active');
                        }
                    });
                });
             });
             dom.loginForm.addEventListener('submit', handleLogin);
             dom.registerForm.addEventListener('submit', handleRegister);
             dom.moodForm.addEventListener('submit', handleMoodFormSubmit);
             
            dom.closeUserGuideButton.addEventListener('click', () => {
                dom.firstTimeUserGuideModal.classList.add('hidden');
                dom.firstTimeUserGuideModal.classList.remove('flex');
                localStorage.setItem('biofeedback_visited', 'true');
            });

             // Info Modals
            document.getElementById('breathingInfoBtn').addEventListener('click', () => document.getElementById('breathingInfoModal').classList.remove('hidden'));
            document.getElementById('closeBreathingInfoBtn').addEventListener('click', () => document.getElementById('breathingInfoModal').classList.add('hidden'));
            document.getElementById('visualInfoBtn').addEventListener('click', () => document.getElementById('visualInfoModal').classList.remove('hidden'));
            document.getElementById('closeVisualInfoBtn').addEventListener('click', () => document.getElementById('visualInfoModal').classList.add('hidden'));
            document.getElementById('eyeMovementInfoBtn').addEventListener('click', () => document.getElementById('eyeMovementInfoModal').classList.remove('hidden'));
            document.getElementById('closeEyeMovementInfoBtn').addEventListener('click', () => document.getElementById('eyeMovementInfoModal').classList.add('hidden'));
            document.getElementById('audioInfoBtn').addEventListener('click', () => document.getElementById('audioInfoModal').classList.remove('hidden'));
            document.getElementById('closeAudioInfoBtn').addEventListener('click', () => document.getElementById('audioInfoModal').classList.add('hidden'));
            
            // Reset Progress handlers
            dom.resetProgressBtn.addEventListener('click', () => {
                dom.resetConfirmationModal.classList.remove('hidden');
                dom.resetConfirmationModal.classList.add('flex');
            });
            dom.downloadProgressBtn.addEventListener('click', downloadProgressData);
            dom.cancelResetBtn.addEventListener('click', () => {
                dom.resetConfirmationModal.classList.add('hidden');
                dom.resetConfirmationModal.classList.remove('flex');
            });
            dom.confirmResetBtn.addEventListener('click', () => {
                if (currentUser) {
                    localStorage.removeItem(`sessions_${currentUser.email}`);
                    fetchAndRenderSessionHistory();
                }
                dom.resetConfirmationModal.classList.add('hidden');
                dom.resetConfirmationModal.classList.remove('flex');
            });
        }
        
        // --- Remaining Global Functions (Auth, Mood, UI Updates) ---

        function handleMoodFormSubmit(e) {
            e.preventDefault();
            const rating = new FormData(dom.moodForm).get(currentQuestion.id);
            if (!rating) return;

            dom.moodQuestionnaireModal.classList.add('hidden');
            dom.moodQuestionnaireModal.classList.remove('flex');
            dom.moodForm.reset();

            if (pendingSessionStart) {
                const startFunction = pendingSessionStart;
                pendingSessionStart = null;
                startFunction(parseInt(rating));
            } else if (pendingSessionEnd) {
                 const endFunction = pendingSessionEnd;
                 pendingSessionEnd = null;
                 endFunction(parseInt(rating));
            }
        }
        
        function populateQuestionnaire() {
            const question = moodQuestions[0];
            currentQuestion = question;
            const formContent = `
                <label for="${question.id}-rating" class="block text-center text-lg mb-4">${question.text}</label>
                <div id="mood-likert-scale">
                    ${question.labels.map((label, index) => `
                        <label>
                            <input type="radio" name="${question.id}" value="${index + 1}" required class="w-5 h-5 accent-sky-500">
                            <span class="text-xs text-slate-600 dark:text-slate-300">${label}</span>
                        </label>
                    `).join('')}
                </div>
                <button type="submit" class="mt-6 w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">Continue</button>
            `;
            dom.moodForm.innerHTML = formContent;
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                dom.body.classList.add('dark-mode');
                dom.themeToggle.checked = true;
                currentTheme = 'dark';
            } else {
                dom.body.classList.remove('dark-mode');
                dom.themeToggle.checked = false;
                currentTheme = 'light';
            }
            if (currentUser) {
                fetchAndRenderSessionHistory();
            }
        }
        
        function showDashboard() {
            dom.allSections.forEach(section => section.classList.add('hidden'));
            dom.dashboard.classList.remove('hidden');

            if (currentUser) {
                dom.wellnessHub.classList.remove('hidden');
                fetchAndRenderSessionHistory();
            } else {
                dom.wellnessHub.classList.add('hidden');
            }
            dom.mainAppWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function showModule(moduleName) {
            dom.dashboard.classList.add('hidden');
            dom.wellnessHub.classList.add('hidden');
            const targetSection = document.getElementById(`${moduleName}App`) || document.getElementById(`${moduleName}ControlApp`) || document.getElementById(`${moduleName}EntrainmentApp`);

            if (targetSection) {
                targetSection.classList.remove('hidden');
                const backBtn = targetSection.querySelector('.back-to-dashboard-btn');
                if (backBtn) backBtn.classList.remove('hidden');
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }


        // --- AUTH ---
        function updateAuthUI() {
            dom.authContainer.innerHTML = ''; 
            if (currentUser) {
                const welcomeEl = document.createElement('span');
                welcomeEl.className = 'text-sm font-medium text-slate-700 dark:text-slate-300';
                welcomeEl.textContent = `Welcome, ${currentUser.email.split('@')[0]}`;
                
                const signOutBtn = document.createElement('button');
                signOutBtn.id = 'signOutButton';
                signOutBtn.className = 'text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-500 dark:hover:text-sky-400 transition-colors';
                signOutBtn.textContent = 'Sign Out';
                signOutBtn.onclick = handleSignOut;

                dom.authContainer.append(welcomeEl, signOutBtn);
                dom.moodMeasureCheckbox.disabled = false;
            } else {
                const signInBtn = document.createElement('a');
                signInBtn.href = '#';
                signInBtn.id = 'signInButton';
                signInBtn.className = 'text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-500 dark:hover:text-sky-400 transition-colors';
                signInBtn.textContent = 'Sign In';
                signInBtn.onclick = () => dom.authModal.classList.remove('hidden');
                
                dom.authContainer.appendChild(signInBtn);
                dom.moodMeasureCheckbox.checked = false;
                dom.moodMeasureCheckbox.disabled = true;
            }
             showDashboard();
        }

        function closeAuthModal() {
            dom.authModal.classList.add('hidden');
            dom.loginErrorEl.textContent = '';
            dom.registerErrorEl.textContent = '';
        }

        async function handleLogin(e) {
            e.preventDefault();
            dom.loginErrorEl.textContent = '';
            const email = dom.loginForm.loginEmail.value;
            const password = dom.loginForm.loginPassword.value;
            
            const users = JSON.parse(localStorage.getItem('biofeedback_users')) || {};
            if (users[email] && users[email].password === password) {
                 currentUser = { email: email, token: 'mock-token-for-' + email };
                 localStorage.setItem('biofeedback_session', JSON.stringify(currentUser));
                 updateAuthUI();
                 closeAuthModal();
            } else {
                 dom.loginErrorEl.textContent = 'Invalid email or password.';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            dom.registerErrorEl.textContent = '';
            const email = dom.registerForm.registerEmail.value;
            const password = dom.registerForm.registerPassword.value;

            if(password.length < 6) {
                dom.registerErrorEl.textContent = 'Password must be at least 6 characters.';
                return;
            }

            const users = JSON.parse(localStorage.getItem('biofeedback_users')) || {};
            if (users[email]) {
                dom.registerErrorEl.textContent = 'An account with this email already exists.';
            } else {
                users[email] = { password };
                localStorage.setItem('biofeedback_users', JSON.stringify(users));
                
                currentUser = { email: email, token: 'mock-token-for-' + email };
                localStorage.setItem('biofeedback_session', JSON.stringify(currentUser));
                updateAuthUI();
                closeAuthModal();
            }
        }

        function handleSignOut() {
            currentUser = null;
            localStorage.removeItem('biofeedback_session');
            localStorage.removeItem('biofeedback_moodMeasureEnabled');
            updateAuthUI();
        }

        // --- Data & History ---
        async function saveSession(sessionData) {
            if (!currentUser) return;
            const sessionHistory = JSON.parse(localStorage.getItem(`sessions_${currentUser.email}`)) || [];
            sessionHistory.unshift({ ...sessionData, completedDate: new Date().toISOString() });
            localStorage.setItem(`sessions_${currentUser.email}`, JSON.stringify(sessionHistory));
            fetchAndRenderSessionHistory();
        }
        
        async function fetchAndRenderSessionHistory() {
            if (!currentUser) return;
            const sessions = JSON.parse(localStorage.getItem(`sessions_${currentUser.email}`)) || [];
            renderSessionHistory(sessions);
            renderProgressChart(sessions);
            
            // Show/hide download button based on whether there's data
            if (sessions.length > 0) {
                dom.downloadProgressBtn.classList.remove('hidden');
            } else {
                dom.downloadProgressBtn.classList.add('hidden');
            }
        }
        
        function downloadProgressData() {
            if (!currentUser) return;
            const sessions = JSON.parse(localStorage.getItem(`sessions_${currentUser.email}`)) || [];
            
            if (sessions.length === 0) {
                alert('No session data to download.');
                return;
            }
            
            // Create CSV header
            const csvHeaders = ['Module Type', 'Duration (min)', 'Mood (Pre → Post)', 'Date', 'Settings'];
            
            // Convert sessions to CSV rows
            const csvRows = sessions.map(session => {
                const settingsString = Object.entries(session.settings).map(([key, value]) => `${key}: ${value}`).join('; ');
                const moodString = session.mood && session.mood.pre !== undefined && session.mood.post !== undefined && session.mood.post !== null
                    ? `${session.mood.pre} → ${session.mood.post}`
                    : (session.mood && session.mood.pre !== undefined ? `${session.mood.pre} → N/A` : 'N/A');
                
                return [
                    session.moduleType,
                    session.duration,
                    moodString,
                    new Date(session.completedDate).toLocaleDateString(),
                    `"${settingsString}"` // Wrap in quotes to handle commas in settings
                ];
            });
            
            // Combine headers and rows
            const csvContent = [csvHeaders, ...csvRows]
                .map(row => row.join(','))
                .join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `biofeedback-progress-${currentUser.email}-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function renderSessionHistory(sessions) {
             dom.sessionHistoryTableBody.innerHTML = '';
             if (sessions.length === 0) {
                 dom.sessionHistoryTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-sm">No session history yet. Complete a session to see it here!</td></tr>`;
                 return;
             }

             sessions.forEach(session => {
                 const row = document.createElement('tr');
                 const settingsString = Object.entries(session.settings).map(([key, value]) => `${key}: ${value}`).join(', ');
                 const moodString = session.mood && session.mood.pre !== undefined && session.mood.post !== undefined && session.mood.post !== null
                    ? `${session.mood.pre} &rarr; ${session.mood.post}`
                    : (session.mood.pre !== undefined ? `${session.mood.pre} &rarr; N/A` : 'N/A');
                 
                 row.innerHTML = `
                     <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${session.moduleType}</td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm">${session.duration} min</td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${moodString}</td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(session.completedDate).toLocaleDateString()}</td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm">${settingsString}</td>
                 `;
                 dom.sessionHistoryTableBody.appendChild(row);
             });
        }
        
        function renderProgressChart(sessions) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const progressVisualization = document.getElementById('progressVisualization');
            const sessionsWithMood = sessions.filter(s => s.mood && s.mood.pre !== undefined && s.mood.post !== undefined && s.mood.post !== null).reverse();

            if (sessionsWithMood.length === 0) {
                 progressVisualization.style.display = 'none';
                 return;
            }
            progressVisualization.style.display = 'block';

            const labels = sessionsWithMood.map(s => new Date(s.completedDate).toLocaleDateString());
            const preSessionData = sessionsWithMood.map(s => s.mood.pre);
            const postSessionData = sessionsWithMood.map(s => s.mood.post);
            
            const isDarkMode = dom.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#f1f5f9' : '#1e293b';

            if (moodChart) moodChart.destroy();

            moodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Pre-Session ${currentQuestion.id}`, data: preSessionData,
                        borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.1
                    }, {
                        label: `Post-Session ${currentQuestion.id}`, data: postSessionData,
                        borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 5.5, ticks: { stepSize: 1, color: labelColor }, grid: { color: gridColor } },
                        x: { ticks: { color: labelColor }, grid: { color: gridColor } }
                    },
                    plugins: { legend: { labels: { color: labelColor } } }
                }
            });
        }

        // --- Load Saved Settings ---
        function initializeDefaultValues() {
            const savedSession = localStorage.getItem('biofeedback_session');
            if (savedSession) currentUser = JSON.parse(savedSession);
            updateAuthUI();

            applyTheme(localStorage.getItem('biofeedback_theme') || 'light');
            
            const moodEnabled = localStorage.getItem('biofeedback_moodMeasureEnabled') === 'true';
            dom.moodMeasureCheckbox.checked = moodEnabled && currentUser;

            if (!localStorage.getItem('biofeedback_visited')) {
                dom.firstTimeUserGuideModal.classList.remove('hidden');
                dom.firstTimeUserGuideModal.classList.add('flex');
            }
        }
        
        // --- Run App ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        // Mobile audio handlers
        function showMobileAudioActivationModal() {
            const mobileAudioActivationModal = document.getElementById('mobileAudioActivationModal');
            mobileAudioActivationModal.classList.remove('hidden');
            mobileAudioActivationModal.classList.add('flex');
        }
        document.getElementById('enableMobileAudioButton').addEventListener('click', () => {
            if (createAudioContext()) {
                mobileAudioEnabled = true;
                const btn = document.getElementById('enableMobileAudioButton');
                btn.textContent = "Audio Enabled ✓";
                btn.classList.add('bg-green-500');
                document.getElementById('audioTestArea').classList.remove('hidden');
            }
        });
         document.getElementById('closeMobileAudioModalButton').addEventListener('click', () => {
            document.getElementById('mobileAudioActivationModal').classList.add('hidden');
         });


    </script>
</body>
</html>

